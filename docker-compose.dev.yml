version: '3.8'

services:
  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: nestjs-rabbitmq-dev
    hostname: rabbitmq
    ports:
      - '5672:5672' # AMQP port
      - '15672:15672' # Management UI port
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
      RABBITMQ_DEFAULT_VHOST: /
    volumes:
      - rabbitmq_dev_data:/var/lib/rabbitmq
    networks:
      - microservices-network
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 60s

  # User Service (Development)
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
      target: builder # Use builder stage for development
    container_name: nestjs-user-service-dev
    environment:
      - NODE_ENV=development
      - RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672
    volumes:
      - ./user-service/src:/app/src
      - ./user-service/package.json:/app/package.json
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - microservices-network
    command: ['yarn', 'start:dev']

  # Auth Service (Development)
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
      target: builder # Use builder stage for development
    container_name: nestjs-auth-service-dev
    environment:
      - NODE_ENV=development
      - PORT=5001
      - RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672
    ports:
      - '5001:5001'
    volumes:
      - ./auth-service/src:/app/src
      - ./auth-service/package.json:/app/package.json
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - microservices-network
    command: ['yarn', 'start:dev']

  # API Gateway (Development)
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
      target: builder # Use builder stage for development
    container_name: nestjs-api-gateway-dev
    environment:
      - NODE_ENV=development
      - PORT=5000
      - RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672
    ports:
      - '5000:5000'
    volumes:
      - ./api-gateway/src:/app/src
      - ./api-gateway/package.json:/app/package.json
    depends_on:
      rabbitmq:
        condition: service_healthy
      user-service:
        condition: service_started
    networks:
      - microservices-network
    command: ['yarn', 'start:dev']

volumes:
  rabbitmq_dev_data:
    driver: local

networks:
  microservices-network:
    driver: bridge
